# Hackload Ticketing Service Provider - Документация API для клиентов

## Обзор

Hackload Ticketing Service Provider — это REST API сервис для управления заказами билетов и бронированием мест. Сервис предоставляет две основные роли пользователей:
- **Администратор**: Может создавать и управлять местами/сиденьями в заведении
- **Партнеры**: Могут создавать заказы, выбирать места и управлять бронированием


## Эндпоинты API

### Эндпоинты партнеров

#### 1. Начать заказ
Создает новый заказ и возвращает ID заказа.

**Эндпоинт:** `POST /api/partners/v1/orders`

**Ответ (201 Created):**
```json
{
  "order_id": "98c123b9-fc80-4d6b-a3f6-0cbe84e0fd88"
}
```

**Пример:**
```bash
curl -X POST "http://localhost:8080/api/partners/v1/orders"
```

#### 2. Получить заказ
Получает детали заказа по ID.

**Эндпоинт:** `GET /api/partners/v1/orders/{id}`

**Ответ (200 OK):**
```json
{
  "id": "98c123b9-fc80-4d6b-a3f6-0cbe84e0fd88",
  "status": "STARTED",
  "started_at": 1753513916968,
  "updated_at": 1753513966871,
  "places_count": 1
}
```

**Пример:**
```bash
curl -X GET "http://localhost:8080/api/partners/v1/orders/98c123b9-fc80-4d6b-a3f6-0cbe84e0fd88"
```

#### 3. Отправить заказ
Отправляет заказ на обработку. После отправки можно только подтвердить или отменить заказ.

**Эндпоинт:** `PATCH /api/partners/v1/orders/{id}/submit`

**Ответ:** `200 OK` (без тела)

**Пример:**
```bash
curl -X PATCH "http://localhost:8080/api/partners/v1/orders/98c123b9-fc80-4d6b-a3f6-0cbe84e0fd88/submit"
```

#### 4. Подтвердить заказ
Подтверждает заказ (терминальный статус - дальнейшие изменения невозможны).

**Эндпоинт:** `PATCH /api/partners/v1/orders/{id}/confirm`

**Ответ:** `200 OK` (без тела)

**Пример:**
```bash
curl -X PATCH "http://localhost:8080/api/partners/v1/orders/98c123b9-fc80-4d6b-a3f6-0cbe84e0fd88/confirm"
```

#### 5. Отменить заказ
Отменяет заказ. Подтвержденные заказы не могут быть отменены.

**Эндпоинт:** `PATCH /api/partners/v1/orders/{id}/cancel`

**Ответ:** `200 OK` (без тела)

**Пример:**
```bash
curl -X PATCH "http://localhost:8080/api/partners/v1/orders/98c123b9-fc80-4d6b-a3f6-0cbe84e0fd88/cancel"
```

#### 6. Список мест
Получает доступные места с пагинацией.

**Эндпоинт:** `GET /api/partners/v1/places?page={page}&pageSize={pageSize}`

**Параметры запроса:**
- `page` (необязательно): Номер страницы (по умолчанию: 1, минимум: 1)
- `pageSize` (необязательно): Элементов на странице (по умолчанию: 20, максимум: 1000)

**Ответ (200 OK):**
```json
[
  {
    "id": "1bf2726c-b6b7-459f-be3f-8124ecd7c619",
    "row": 1,
    "seat": 1,
    "is_free": true
  }
]
```

**Пример:**
```bash
curl -X GET "http://localhost:8080/api/partners/v1/places?page=1&pageSize=20"
```

#### 7. Получить отдельное место
Получает детали конкретного места.

**Эндпоинт:** `GET /api/partners/v1/places/{id}`

**Ответ (200 OK):**
```json
{
  "id": "1bf2726c-b6b7-459f-be3f-8124ecd7c619",
  "row": 1,
  "seat": 1,
  "is_free": true
}
```

**Пример:**
```bash
curl -X GET "http://localhost:8080/api/partners/v1/places/1bf2726c-b6b7-459f-be3f-8124ecd7c619"
```

#### 8. Выбрать место
Выбирает/резервирует место для заказа.

**Эндпоинт:** `PATCH /api/partners/v1/places/{id}/select`

**Тело запроса:**
```json
{
  "order_id": "98c123b9-fc80-4d6b-a3f6-0cbe84e0fd88"
}
```

**Ответ:** `204 No Content` (без тела)

**Пример:**
```bash
curl -X PATCH "http://localhost:8080/api/partners/v1/places/1bf2726c-b6b7-459f-be3f-8124ecd7c619/select" \
  -H "Content-Type: application/json" \
  -d '{
    "order_id": "98c123b9-fc80-4d6b-a3f6-0cbe84e0fd88"
  }'
```

#### 9. Освободить место
Освобождает выбранное место (работает только с начатыми заказами).

**Эндпоинт:** `PATCH /api/partners/v1/places/{id}/release`

**Ответ:** `204 No Content` (без тела)

**Пример:**
```bash
curl -X PATCH "http://localhost:8080/api/partners/v1/places/1bf2726c-b6b7-459f-be3f-8124ecd7c619/release"
```

## Сценарии использования сервиса

### Типичный рабочий процесс заказа

1. **Начать новый заказ**
   - Вызвать `POST /api/partners/v1/orders`
   - Получить ID заказа для последующих операций

2. **Просмотреть доступные места**
   - Вызвать `GET /api/partners/v1/places` для просмотра доступных мест
   - Фильтровать по `is_free: true` для поиска свободных мест

3. **Выбрать места для заказа**
   - Вызвать `PATCH /api/partners/v1/places/{id}/select` для каждого желаемого места
   - Место становится `is_free: false` и резервируется для вашего заказа

4. **Просмотреть заказ**
   - Вызвать `GET /api/partners/v1/orders/{id}` для проверки деталей заказа
   - Убедиться, что `places_count` соответствует выбранным местам

5. **Отправить заказ**
   - Вызвать `PATCH /api/partners/v1/orders/{id}/submit`
   - Статус заказа изменится на `SUBMITTED`
   - Больше нельзя добавлять/удалять места

6. **Финальное действие**
   - **Подтвердить:** Вызвать `PATCH /api/partners/v1/orders/{id}/confirm` (терминальный)
   - **Отменить:** Вызвать `PATCH /api/partners/v1/orders/{id}/cancel`

### Состояния заказа и переходы

```
STARTED → SUBMITTED → CONFIRMED (терминальный)
   ↓         ↓
CANCELLED ← CANCELLED
```

- **STARTED**: Можно добавлять/удалять места, отправлять или отменять
- **SUBMITTED**: Можно только подтвердить или отменить
- **CONFIRMED**: Терминальное состояние (изменения невозможны)
- **CANCELLED**: Терминальное состояние (изменения невозможны)

### Административная настройка

1. **Создать планировку заведения**
   - Использовать `POST /api/admin/v1/places` для создания мест
   - Настроить ряды и номера мест согласно планировке заведения

## Обработка ошибок

### Коды состояния HTTP

- **200 OK**: Запрос успешно выполнен
- **201 Created**: Ресурс успешно создан
- **204 No Content**: Запрос выполнен успешно без тела ответа
- **404 Not Found**: Ресурс не найден
- **409 Conflict**: Нарушение бизнес-правил
- **422 Unprocessable Entity**: Неверный формат запроса
- **403 Forbidden**: Операция не разрешена
- **500 Internal Server Error**: Ошибка сервера

### Ошибки бизнес-логики (409 Conflict)

#### Ошибки, связанные с заказами
- **OrderNotStartedException**: Попытка операций с не начатым заказом
- **OrderNotSubmittedException**: Попытка подтвердить заказ, который не был отправлен
- **OrderAlreadyCancelledException**: Попытка операций с отмененным заказом
- **ConfirmedOrderCanNotBeCancelledException**: Попытка отменить подтвержденный заказ
- **NoPlacesAddedException**: Попытка отправить заказ без мест

#### Ошибки, связанные с местами (409 Conflict)
- **PlaceAlreadySelectedException**: Попытка выбрать уже зарезервированное место
- **PlaceCanNotBeAddedToOrderException**: Место не может быть добавлено к указанному заказу

#### Ошибки, связанные с местами (403 Forbidden)
- **PlaceSelectedForAnotherOrderException**: Попытка освободить место, выбранное для другого заказа

#### Другие ошибки
- **PlaceNotAddedException**: Попытка удалить место, которое не было добавлено к заказу

### Формат ответа об ошибке

Ошибки возвращают соответствующие коды состояния HTTP. Для нарушений бизнес-логики проверьте ожидаемые коды состояния в конкретных эндпоинтах выше.

## Лучшие практики

### Для партнеров

1. **Управление заказами**
   - Всегда начинайте с создания заказа
   - Проверяйте статус заказа перед выполнением операций
   - Отправляйте заказы только когда все желаемые места выбраны

2. **Выбор мест**
   - Проверяйте статус `is_free` перед попыткой выбора
   - Корректно обрабатывайте конфликты когда места уже заняты
   - Своевременно освобождайте места если заказ отменен

3. **Обработка ошибок**
   - Реализуйте логику повторных попыток для ответов 409 Conflict
   - Обрабатывайте ответы 404 для несуществующих ресурсов
   - Ведите логи и мониторинг ошибок 500 для системных проблем
